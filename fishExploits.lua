local old_time = 0
local number = 0;
local localPlayerClient;
local localPlayer;
local endingAngle = Vector.new(0, 0, 0);

local fishExploitsEnabled = menu.SwitchColor("Neverlose", "Fish Exploits", false, Color.new(1.0, 1.0, 1.0, 1.0), "Turn on Fish Exploits");
local fishPhysgunEnabled = menu.SwitchColor("Neverlose", "Fish Physgun", false, Color.new(1.0, 1.0, 1.0, 1.0), "Turn on Fish Physgunning");
local fishSpinbotEnabled = menu.SwitchColor("Neverlose", "Fish Spinbot", false, Color.new(1.0, 1.0, 1.0, 1.0), "Turn on Fish Spinbot");
local fishSpinbotSpeed = menu.SliderInt("Neverlose", "Spinbot Speed", 150, 1, 300, "Fish Spinbot Speed")
local fishFeetEnabled = menu.SwitchColor("Neverlose", "Fish Feet", false, Color.new(1.0, 1.0, 1.0, 1.0), "Teleport all fish to your feet");
local fishModelChangerEnabled = menu.SwitchColor("Neverlose", "Fish Model", false, Color.new(1.0, 1.0, 1.0, 1.0), "Turn on Custom Fish Model");
local fishModelIndex = menu.SliderInt("Neverlose", "Fish Model Index", 758, 50, 758, "Model Index")

local function degreesToRadians(degree)
    return degree * math.pi / 180.0;
end

local function fromAngle(angle)
    return Vector.new(math.cos(degreesToRadians(angle.pitch)) * math.cos(degreesToRadians(angle.yaw)), math.cos(degreesToRadians(angle.pitch)) * math.sin(degreesToRadians(angle.yaw)), -1 * math.sin(degreesToRadians(angle.pitch)));
end

local function setFishValues(fishEnt, origin, x, y, z)
    if (origin ~= nil) then
        fishEnt:SetProp("DT_CFish", "m_poolOrigin", origin)
    end

    if (x ~= nil and y ~= nil and z ~= nil) then
        fishEnt:SetProp("DT_CFish", "m_x", x)
        fishEnt:SetProp("DT_CFish", "m_y", y)
        fishEnt:SetProp("DT_CFish", "m_z", z + 10)
    end
end

cheat.RegisterCallback("override_view", function(e)
    endingAngle = fromAngle(e.angles);
end);

cheat.RegisterCallback("draw", function()
    if (fishExploitsEnabled:GetBool()) then
        localPlayerClient = g_EngineClient:GetLocalPlayer();
        localPlayer = g_EntityList:GetClientEntity(localPlayerClient);
        local lp = localPlayer:GetPlayer();
        local curtime = g_GlobalVars.curtime

        if (localPlayer and lp) then
            local viewOffset = lp:GetEyePosition()
            local crosshairLocation = viewOffset + endingAngle * 10000;
            local trace = g_EngineTrace:TraceRay(viewOffset, crosshairLocation, localPlayer, 0xFFFFFFFF);
            local crosshairEndPos = trace.endpos;    
            local localOrigin = localPlayer:GetRenderOrigin()

            if (fishSpinbotEnabled:GetBool()) then
                if (fishSpinbotSpeed:GetInt() >= 1 and fishSpinbotSpeed:GetInt() <= 300) then
                    if (curtime - old_time) >= fishSpinbotSpeed:GetInt() / 10000 then
                        if (number >= 360) then number= 0; end
                        number = number + 1
                        old_time = curtime
                    end
                end
            end

            local fishEnts = cheat.GetEntitiesByName("CFish")
            for i = 1, #fishEnts do
                if (fishSpinbotEnabled:GetBool()) then
                    fishEnts[i]:SetProp("DT_CFish", "m_angle", number)
                end

                if (fishPhysgunEnabled:GetBool()) then
                    if (cheat.IsKeyDown(0x1)) then
                        setFishValues(fishEnts[i], Vector.new(crosshairEndPos.x, crosshairEndPos.y, crosshairEndPos.z), crosshairEndPos.x, crosshairEndPos.y, crosshairEndPos.z)
                        
                    elseif (fishFeetEnabled:GetBool()) then
                        setFishValues(fishEnts[i], Vector.new(localOrigin.x, localOrigin.y, localOrigin.z), localOrigin.x, localOrigin.y, localOrigin.z)
                    end
                elseif (fishFeetEnabled:GetBool()) then
                    setFishValues(fishEnts[i], Vector.new(localOrigin.x, localOrigin.y, localOrigin.z), localOrigin.x, localOrigin.y, localOrigin.z)
                end

                if (fishModelChangerEnabled:GetBool()) then
                    if (fishModelIndex:GetInt() >= 50) then
                        fishEnts[i]:SetProp("DT_CFish", "m_nModelIndex", fishModelIndex:GetInt())
                    end
                else
                    fishEnts[i]:SetProp("DT_CFish", "m_nModelIndex", 758)
                end
            end
        end
    end
end)
